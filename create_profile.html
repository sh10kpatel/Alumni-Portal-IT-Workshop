<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Create Profile</title>
  <style>
    :root{--bg-1:#071129;--bg-2:#071524;--card:#0b1220;--muted:#9fb8cc;--accent1:#06b6d4;--accent2:#7c3aed}
    body{font-family:Inter,system-ui,Arial,Segoe UI;background:linear-gradient(180deg,var(--bg-1),var(--bg-2));color:#e6eef6;padding:28px}
    .card{background:var(--card);padding:28px;border-radius:12px;max-width:720px;margin:24px auto;color:#e6eef6;box-shadow:0 6px 24px rgba(2,6,23,0.6)}
    h2{margin:0 0 6px 0}
    .hint{font-size:0.95rem;color:var(--muted);margin-top:6px}
    label{display:block;margin-top:12px;font-weight:700;color:#cfe8ff}
    input,select,textarea{width:100%;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:#e6eef6;box-sizing:border-box}
    textarea{resize:vertical}
    .form-row{margin-top:12px}
    .actions{display:flex;gap:12px;margin-top:18px}
    .btn{background:linear-gradient(90deg,var(--accent1),var(--accent2));padding:10px 14px;border-radius:8px;border:none;color:white;font-weight:700;cursor:pointer}
    .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06)}
    .field-error{color:#ffb4b4;margin-top:6px;font-size:0.9rem}
    .image-preview{margin-top:8px}
    .image-preview img{max-width:140px;max-height:140px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);display:none}
    @media (max-width:520px){.card{padding:18px}}
  /* Ensure dropdown options are readable when native dropdown background is white */
  option, select option, .input option, .select option { color: #000 !important; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Create New Profile</h2>
    <p class="hint">Fill the details below and click Create. You'll be returned to the main page after success.</p>

    <form id="createForm" novalidate>
      <div class="form-row"><label>Full Name <input name="name" required autofocus></label></div>

      <div class="form-row"><label>Batch <input name="batch"></label></div>

      <div class="form-row"><label>Role <select name="role"><option value="alumni">Alumni</option><option value="student">Student</option></select></label></div>

      <div class="form-row"><label>Login ID <input name="login_id" placeholder="email or username" required></label></div>

      <div class="form-row"><label>Password <input type="password" name="password" id="password" required minlength="6"></label></div>

      <div class="form-row"><label>Confirm Password <input type="password" name="password2" id="password2" required minlength="6"></label>
        <div id="pwError" class="field-error" aria-live="polite"></div>
      </div>

      <div class="form-row"><label>Branch <input name="branch"></label></div>

      <div class="form-row"><label>Current / Working place <input name="current_place"></label></div>

      <div class="form-row"><label>Education (e.g., MBA, MTech) <input name="education"></label></div>

      <div class="form-row"><label>Experience <textarea name="experience" rows="3"></textarea></label></div>

      <div class="form-row"><label>Certificates (comma separated) <input name="certificates"></label></div>

      <div class="form-row"><label>Description <textarea name="description" rows="3"></textarea></label></div>

      <div class="form-row">
        <label>Profile Image (optional) <input type="file" name="imageFile" id="imageFile" accept="image/*"></label>
        <div class="image-preview" id="imagePreview" aria-hidden="true"><img id="previewImg" alt="Profile preview"/></div>
      </div>

      <div class="actions">
        <button class="btn" type="submit" id="submitBtn">Create Profile</button>
        <button class="btn secondary" type="button" id="cancelBtn">Cancel</button>
      </div>
    </form>
  </div>

<script>
// Auto-detect API base: use same origin if served from a server, otherwise localhost
let API_BASE = window.location.protocol === 'file:' 
    ? 'http://localhost:4000' 
    : window.location.origin;
const params = new URLSearchParams(window.location.search);
const portParam = params.get('apiPort');
const explicitBase = params.get('apiBase');
if (explicitBase) {
  API_BASE = explicitBase.replace(/\/$/, '');
} else if (portParam && window.location.protocol === 'file:') {
  API_BASE = `http://localhost:${portParam}`;
}

// UI element for showing API connectivity status (populated on load)
const apiStatusEl = document.createElement('div');
apiStatusEl.style.marginTop = '8px';
apiStatusEl.style.fontSize = '0.95rem';
apiStatusEl.style.color = '#9fb8cc';
apiStatusEl.id = 'apiStatus';
document.querySelector('.card').insertBefore(apiStatusEl, document.querySelector('.card').children[2]);

async function checkApi() {
  // Try a few candidate hosts (helps when IPv4/IPv6 resolution differs)
  const port = (portParam || new URL(API_BASE).port || '4100');
  const hosts = ['localhost', '127.0.0.1'];
  for (const h of hosts) {
    const url = `http://${h}:${port}/api/alumni`;
    apiStatusEl.textContent = `Checking API at ${url} ...`;
    try {
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), 3000);
      const res = await fetch(url, { signal: controller.signal });
      clearTimeout(id);
      const ct = (res.headers.get('content-type') || '').toLowerCase();
      if (!ct.includes('application/json')) {
        apiStatusEl.textContent = `Unexpected response (content-type=${ct}) from ${url}. It looks like a static server is running on that port â€” start the API (see server/README.md) or use ?apiPort=` + port;
        apiStatusEl.style.color = '#ff8a8a';
        // try next host
        continue;
      }
      if (res.ok) {
        API_BASE = `http://${h}:${port}`; // prefer the working base
        apiStatusEl.textContent = `API reachable at ${API_BASE}`;
        apiStatusEl.style.color = '#8ef';
        return true;
      } else {
        apiStatusEl.textContent = `API reachable but returned ${res.status} at ${url}`;
        apiStatusEl.style.color = '#ffcc66';
        // continue to try other hosts
      }
    } catch (err) {
      apiStatusEl.textContent = `Cannot reach API at ${url}: ${err.name || err.message}`;
      apiStatusEl.style.color = '#ff8a8a';
      // try next host
    }
  }
  return false;
}

// run initial connectivity check
checkApi();

const form = document.getElementById('createForm');
const cancel = document.getElementById('cancelBtn');
const pw = document.getElementById('password');
const pw2 = document.getElementById('password2');
const pwError = document.getElementById('pwError');
const submitBtn = document.getElementById('submitBtn');
const imageFile = document.getElementById('imageFile');
const previewImg = document.getElementById('previewImg');
const imagePreview = document.getElementById('imagePreview');

function validatePasswords() {
  const a = pw.value || '';
  const b = pw2.value || '';
  if (!a && !b) {
    pwError.textContent = '';
    pw.setCustomValidity('');
    pw2.setCustomValidity('');
    submitBtn.disabled = false;
    return true;
  }
  if (a !== b) {
    pwError.textContent = 'Passwords do not match';
    pw2.setCustomValidity('Passwords do not match');
    submitBtn.disabled = true;
    return false;
  }
  pwError.textContent = '';
  pw.setCustomValidity('');
  pw2.setCustomValidity('');
  submitBtn.disabled = false;
  return true;
}

pw.addEventListener('input', validatePasswords);
pw2.addEventListener('input', validatePasswords);

imageFile.addEventListener('change', ()=>{
  const f = imageFile.files && imageFile.files[0];
  if (!f) { previewImg.style.display = 'none'; previewImg.src = ''; imagePreview.setAttribute('aria-hidden','true'); return }
  if (!f.type.startsWith('image/')) { alert('Please select an image file'); imageFile.value = ''; return }
  const reader = new FileReader();
  reader.onload = (ev)=>{
    previewImg.src = ev.target.result;
    previewImg.style.display = 'block';
    imagePreview.setAttribute('aria-hidden','false');
  };
  reader.readAsDataURL(f);
});

form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  if (!validatePasswords()) return;
  submitBtn.disabled = true;
  try{
    // Build FormData including the image file (if any)
    const fd = new FormData(form);
    // remove any empty file entries (some browsers may include empty)
    const f = imageFile.files && imageFile.files[0];
    if (!f) fd.delete('imageFile');

    const postUrl = API_BASE + '/api/alumni/full';
    let res;
    try {
      res = await fetch(postUrl, { method: 'POST', body: fd });
    } catch (err) {
      // network/TypeError occurred; try fallback hosts once
      if (err instanceof TypeError) {
        apiStatusEl.textContent = `Network error when POSTing to ${postUrl}: ${err.message}. Trying fallbacks...`;
        apiStatusEl.style.color = '#ffcc66';
        // try other hosts (if different)
        const port = (portParam || new URL(API_BASE).port || '4100');
        const candidates = ['127.0.0.1','localhost'].filter(h => !API_BASE.includes(h));
        for (const h of candidates) {
          const tryUrl = `http://${h}:${port}/api/alumni/full`;
          try {
            res = await fetch(tryUrl, { method: 'POST', body: fd });
            if (res) {
              const ct2 = (res.headers.get('content-type') || '').toLowerCase();
              if (ct2.includes('text/html')) {
                // static server serving HTML on API port
                apiStatusEl.textContent = `Received HTML from ${tryUrl}. It appears a static server is running on the API port. Start the API server (see server/README.md).`;
                apiStatusEl.style.color = '#ff8a8a';
                res = null;
                continue;
              }
              API_BASE = `http://${h}:${port}`;
              break;
            }
          } catch (err2) {
            // continue
          }
        }
      }
      if (!res) {
        const msg = 'Network error: ' + (err && err.message);
        apiStatusEl.textContent = `${msg} (POST ${postUrl})`;
        apiStatusEl.style.color = '#ff8a8a';
        throw err;
      }
    }
    if (!res.ok) {
      const text = await res.text().catch(()=>null);
      const msg = 'Create failed: ' + (text||res.status);
      // update API status area for easier debugging
      apiStatusEl.textContent = `${msg} (POST ${postUrl})`;
      apiStatusEl.style.color = '#ff8a8a';
      throw new Error(msg);
    }
    const created = await res.json().catch((err)=>{
      console.error('Error parsing response:', err);
      return null;
    });
    console.log('Server response:', created);
    alert('Profile created: ' + (created && created.name ? created.name : 'Success'));
    console.log('Redirecting to mainad.html...');
    window.location.href = 'mainad.html';
  } catch (err) { console.error(err); alert('Failed to create profile: ' + err.message); }
  finally{ submitBtn.disabled = false }
});

cancel.addEventListener('click', ()=> window.location.href='mainad.html');
</script>
</body>
</html>